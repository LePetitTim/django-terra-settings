dist: bionic

sudo: required

language: python

python:
- '3.6'
- '3.7'
- '3.8'

env:
  matrix:
    - DJANGO_VERSION=2.2.*
    - DJANGO_VERSION=3.0.*
    - DJANGO_VERSION=3.1.*
    - DJANGO_VERSION=dev

services:
- postgresql

addons:
  postgresql: '10'

stages:
- lint
- test
- deploy

install:
- pip install -e .[dev]
- pip install codecov
- if [[ $DJANGO_VERSION == dev ]]; then
  pip install -e git+https://github.com/django/django@master#egg=django;
  else
  pip install Django==$DJANGO_VERSION -U;
  fi

before_script:
- psql -c "CREATE USER travis_ci_test WITH ENCRYPTED PASSWORD 'travis_ci_test';" -U postgres
- psql -c "ALTER USER travis_ci_test WITH SUPERUSER;" -U postgres
- psql -c 'CREATE DATABASE travis_ci_test WITH OWNER travis_ci_test;' -U postgres

after_failure:
- pip freeze

script:
- coverage run ./manage.py test

after_success:
  - codecov

jobs:
  allow_failures:
    - env: DJANGO_VERSION=dev
  include:
  - stage: lint
    before_install: skip
    install:
    - pip install flake8
    before_script: skip
    script:
    - flake8 terra_settings test_terra_settings
    after_success: skip

  - stage: deploy
    install: skip
    before_script: skip
    script: skip
    deploy:
      skip_cleanup: true
      stage: deploy
      provider: pypi
      user: "__token__"
      password:
        secure: JgDfqo8GOIbeKuK8tHKsbdNKBBN+oSmM5xJOKEdWJcNZUNzxxnhsKCgpbT075Ne7aWevyAeZXi9eX3iKFrvMoBHZ4HRN+CrKbj4348jy4Uf1sw0g54pDRnFVJgOtJdgJJmix3BBEY6W1Y2tF9jQTWyW6TFgLTlsmFR6TQNh8D4RdCgoiOgtnh+DrtxZczcDWVoTasksooiILnJshf5ZxD2lbCbYxM3p61K1naht0O5r5JJjJfP/bjmgTkPRuOdE3cbVmWK6QEbKH5kfOB8ykVUmjwck5mVP6TtQ0U0eEaFxqx8ofK+1fLeGK0Ixa+57gMqKFzErjpqU0P7O9NpHEL4lHudKkPVEpaFHqrMBvs9esM+3KVYTz2kRohGfaSFejERtCZDWPxkAM5AuSHsF6KsNPsN4dSeS2Cxzk/VKvnf6SghlgSY0R2dh0WZ0MrRgq/ZhzQKgHR0pfx+TevkJJS4hPDNh8as7WBNREevVazMQNyFehxBuNrOEYHT1xR6IXtuYQl0Ieq8rGQ8OqqrLg6FzhT9+KSlOxjvmjyvWVd9dEjsEQOSvd+FlkULosGiZURItHa0+pnW2aLFq7Uoozws3LY1kTF9oSgYpx0B3r2LRKR6pm4Gieq7eWkZW6B17oxYXkAH9b43c+pTUiuL3B5I1EQWFw4XBFHBkBUke4vCU=

      on:
        tags: true
