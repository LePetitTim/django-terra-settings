dist: bionic
sudo: required
language: python

python:
- '3.6'
- '3.7'

services:
  - postgresql

addons:
  postgresql: "10"
  apt:
    packages:
      - postgresql-10-postgis-2.4

stages:
  - lint
  - test
  - deploy

install:
  - sudo apt-get -y install libproj-dev binutils gdal-bin
  - python setup.py install
  - pip install coverage codecov


before_script:
  - psql -c "CREATE USER travis_ci_test WITH ENCRYPTED PASSWORD 'travis_ci_test';" -U postgres
  # allow database creation for test
  - psql -c "ALTER USER travis_ci_test WITH SUPERUSER;" -U postgres
  - psql -c 'CREATE DATABASE travis_ci_test WITH OWNER travis_ci_test;' -U postgres
  - psql -d travis_ci_test -c 'CREATE EXTENSION postgis;'

after_failure:
  - pip freeze

script:
  - coverage run ./manage.py test
  - codecov

jobs:
  include:
    - stage: lint
      install:
        - pip install flake8
      script:
        - flake8 terra_utils

    - stage: deploy
      install: skip
      before_script: skip
      script: skip
      deploy:
        stage: deploy
        provider: pypi
        user: "$PYPI_USER"
        password:
          secure: r8MGNrhecisTRmgd60Z6z08R4aQFfmUkEPLCZ4qmMkwmOvAs1hLLieQuJxO47pT3l5H9tgwBkutL6JthVsU7scykAh8LnI7/7sgoVsF6maxdzKGgoY/PZwv21rFMnc+sSpHEWutEm96NBZGw1hwoMp4rtS0/2moVqfn8h+IxI6w519Xeh/QZRR2HqykVl0HbMHGgUdu7ePELErqFYbcRV18+WHGdhj5S5Kihhw9zELbnnoLOlm43mjzVdA75RVhOs6s4xv6CGmAILnqmasvo6PHguGeBS2B3Nk7qyo1M08D6/bPVdSTnaCAP3zqOKsvGLqRbwFRygpYeIpa5QRdKbFSaktIBxhOROdsRGzFcYzUgiAwDVmXyTzwUVxT2UJ90m4keA3nlu42LJskM3O5LKXQNwTMYmsZ6qn2iSoU7Qp31Is+nAJcl1kEJUOgKgrNd7rJ2hECVhRJc9hhVfX+vQO7jckqx1GI/es6PskkyjL7QwhfqtP1cuy0GSSHdTM+3UfKL0iFt6G4xLkmnMwuV1qHzshgmfl9RY3PYzb/bDn1Yp5LPlxwU2D/5b2dVTHDMJLb4n1+oF7GaYDzzYnGqcJaogNtzwJUTCRj9c916CO+4OvzuusLM+XQk0Yyqs0Ss3UqdNVfF0d3RezaLy/H7Vr+TKSNivxplx4jz3bJFFsg=
        on:
          tags: true
